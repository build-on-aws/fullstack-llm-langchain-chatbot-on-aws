  AWSTemplateFormatVersion: 2010-09-09
  Description: Custom VPC Creation With Private and Public Subnet

  Parameters:
    DemoVPC:
      Type: String
      Default: vpc-123456  # Replace with actual VPC ID
      Description: The VPC that the service is running inside of
    PublicSubnetIds:
      Type: List<AWS::EC2::Subnet::Id>
      Default: subnet-123456 , subnet-123456  # Replace with actual subnet IDs
      Description: List of public subnet IDs to put the load balancer and tasks in
    Imagename:
      Type: String
      Description: Name of the ECR repository
      Default: 123456.dkr.ecr.us-east-1.amazonaws.com/qa-container:latest
    TextEmbeddingModelEndpointName:
      Type: String
      Description: Endpoint name of the Hugging Face embeddings model deployed on Sagemaker
      Default: jumpstart-dft-hf-textembedding-gpt-j-6b-fp16
    T5FlanXXLEndpointName:
      Type: String
      Description: Endpoint name of the T5-FLAN endpoint deployed on sagemaker
      Default: jumpstart-example-huggingface-text2text-2023-08-06-16-40-45-080
    VectorDatabaseEndpoint:
      Type: String
      Description: OpenSearch endpoint name which is the vector database
      Default: abcdef
    VectorDatabaseUsername:
      Type: String
      Description: OpenSearch master username
      Default: master
    VectorDatabasePassword:
      Type: String
      Description: OpenSearch password
      Default: 12345abcd
    VectorDatabaseIndex:
      Type: String
      Description: OpenSearch index
      Default: carmanual
  
  Resources:
    LogGroup:
      Type: AWS::Logs::LogGroup

    PublicLoadBalancerSecurityGroup:
        Type: AWS::EC2::SecurityGroup
        Properties:
          GroupDescription: Access to the public facing load balancer
          VpcId: !Ref DemoVPC
          SecurityGroupIngress:
            # Allow access to ALB from anywhere on the internet
            - CidrIp: 0.0.0.0/0
              IpProtocol: -1

    PublicLoadBalancer:
      Type: AWS::ElasticLoadBalancingV2::LoadBalancer
      Properties:
        Scheme: internet-facing
        Subnets: !Ref PublicSubnetIds
        SecurityGroups:
          - !Ref 'PublicLoadBalancerSecurityGroup'
         
    DummyTargetGroupPublic:
      Type: AWS::ElasticLoadBalancingV2::TargetGroup
      Properties:
        HealthCheckIntervalSeconds: 6
        HealthCheckPath: /
        HealthCheckProtocol: HTTP
        HealthCheckTimeoutSeconds: 5
        HealthyThresholdCount: 2
        Name: "no-op"
        Port: 80
        Protocol: HTTP
        UnhealthyThresholdCount: 2
        VpcId: !Ref DemoVPC

    PublicLoadBalancerListener:
      Type: AWS::ElasticLoadBalancingV2::Listener
      Properties:
        DefaultActions:
          - TargetGroupArn: !Ref 'DummyTargetGroupPublic'
            Type: 'forward'
        LoadBalancerArn: !Ref 'PublicLoadBalancer'
        Port: 80
        Protocol: HTTP

    ECSRole:
      Type: 'AWS::IAM::Role'
      Properties:
        AssumeRolePolicyDocument:
          Version: "2012-10-17"
          Statement:
            - Effect: Allow
              Principal:
                Service:
                  - ecs-tasks.amazonaws.com
              Action:
                - 'sts:AssumeRole'
        ManagedPolicyArns:
          - arn:aws:iam::aws:policy/service-role/AmazonECSTaskExecutionRolePolicy
          - arn:aws:iam::aws:policy/AmazonESFullAccess  # Add Amazon ES full access policy
          - arn:aws:iam::aws:policy/AmazonSageMakerFullAccess  # Add Amazon SageMaker full access policy
        Policies:
          - PolicyName: ecs-policy
            PolicyDocument:
              Version: "2012-10-17"
              Statement:
                - Effect: Allow
                  Action: 
                    - "ecr:GetAuthorizationToken"
                    - "ecr:BatchCheckLayerAvailability"
                    - "ecr:GetDownloadUrlForLayer"
                    - "ecr:BatchGetImage"
                    - "logs:CreateLogStream"
                    - "logs:PutLogEvents"
                  Resource: '*'

    ECSCluster:
      Type: AWS::ECS::Cluster

    ECSSecurityGroup:
      Type: AWS::EC2::SecurityGroup
      Properties:
        GroupDescription: Access to the public ECS containers
        VpcId: !Ref DemoVPC


    ECSSecurityGroupIngressFromPublicALB:
      Type: AWS::EC2::SecurityGroupIngress
      Properties:
        Description: Ingress from the public ALB
        GroupId: !Ref 'ECSSecurityGroup'
        IpProtocol: -1
        SourceSecurityGroupId: !Ref 'PublicLoadBalancerSecurityGroup'

    ECSSecurityGroupIngressFromSelfPublic:
      Type: AWS::EC2::SecurityGroupIngress
      Properties:
        Description: Ingress from other containers in the same security group
        GroupId: !Ref 'ECSSecurityGroup'
        IpProtocol: -1
        SourceSecurityGroupId: !Ref 'ECSSecurityGroup'

    EcsFrontTaskDefinition:
      Type: AWS::ECS::TaskDefinition
      Properties:
        Cpu: 512
        Memory: 1024
        NetworkMode: awsvpc
        ExecutionRoleArn: !GetAtt ECSRole.Arn
        TaskRoleArn: !GetAtt ECSRole.Arn      # ARN of the Task Role
        RequiresCompatibilities:
          - FARGATE
        ContainerDefinitions:
          - Name: "ecs-front-container"
            Image: !Ref Imagename
            Environment:
              - Name: TEXT_EMBEDDING_MODEL_ENDPOINT_NAME
                Value: !Ref TextEmbeddingModelEndpointName
              - Name: T5FLAN_XXL_ENDPOINT_NAME
                Value: !Ref T5FlanXXLEndpointName
              - Name: VECTOR_DB_ENDPOINT
                Value: !Ref VectorDatabaseEndpoint
              - Name: VECTOR_DB_USERNAME
                Value: !Ref VectorDatabaseUsername
              - Name: VECTOR_DB_PASSWORD
                Value: !Ref VectorDatabasePassword
              - Name: VECTOR_DB_INDEX
                Value: !Ref VectorDatabaseIndex              
            PortMappings:
              - ContainerPort: 80
            LogConfiguration:
              LogDriver: 'awslogs'
              Options:
                awslogs-group: !Ref LogGroup
                awslogs-region: !Ref AWS::Region
                awslogs-stream-prefix: 'qa-llm'

    EcsFrontService:
      Type: AWS::ECS::Service
      DependsOn: LoadBalancerRule
      Properties:
        Cluster: !Ref ECSCluster
        LaunchType: FARGATE
        DeploymentConfiguration:
          MaximumPercent: 200
          MinimumHealthyPercent: 100
        DesiredCount: 2
        NetworkConfiguration:
          AwsvpcConfiguration:
            AssignPublicIp: ENABLED
            SecurityGroups:
              - !Ref ECSSecurityGroup
            Subnets: !Ref PublicSubnetIds  # Use the provided public subnet IDs here
        TaskDefinition: !Ref EcsFrontTaskDefinition
        LoadBalancers:
          - ContainerName: "ecs-front-container"
            ContainerPort: 80
            TargetGroupArn: !Ref 'EcsServiceTargetGroup'

    EcsServiceTargetGroup:
      Type: AWS::ElasticLoadBalancingV2::TargetGroup
      Properties:
        HealthCheckIntervalSeconds: 6
        HealthCheckPath: /health
        HealthCheckProtocol: HTTP
        HealthCheckTimeoutSeconds: 5
        HealthyThresholdCount: 2
        TargetType: ip
        Name: 'ecs-frontend-service'
        Port: 80
        Protocol: HTTP
        UnhealthyThresholdCount: 2
        VpcId: !Ref DemoVPC

  # Create a rule on the load balancer for routing traffic to the target group
    LoadBalancerRule:
      Type: AWS::ElasticLoadBalancingV2::ListenerRule
      Properties:
        Actions:
          - TargetGroupArn: !Ref 'EcsServiceTargetGroup'
            Type: 'forward'
        Conditions:
          - Field: path-pattern
            Values: 
              - '*'
        ListenerArn: !Ref PublicLoadBalancerListener
        Priority: 1

        
  Outputs:
    PublicAPIEndpoint:
      Description: Dns of the public ALB
      Value:  
        Fn::Sub: "http://${PublicLoadBalancer.DNSName}/qa"